#!/bin/bash
set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Check if bun is installed AND is a native binary (not Windows .exe in WSL)
BUN_PATH=$(command -v bun 2>/dev/null || echo "")
NEED_INSTALL=false

if [ -z "$BUN_PATH" ]; then
    # Bun not found at all
    NEED_INSTALL=true
elif [[ "$BUN_PATH" == *.exe ]] || [[ "$BUN_PATH" == *"/mnt/c/"* ]] || [[ "$BUN_PATH" == *"\\wsl"* ]]; then
    # Found Windows bun in WSL - need to install native bun
    echo "âš ï¸  Detected Windows Bun in WSL environment"
    echo "   Installing native WSL Bun for compatibility..."
    echo
    NEED_INSTALL=true
fi

if [ "$NEED_INSTALL" = true ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  ğŸ”§ Installing Bun..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    curl -fsSL https://bun.sh/install | bash

    # Add bun to PATH for this session
    export PATH="$HOME/.bun/bin:$PATH"

    echo
    echo "âœ… Bun installed successfully!"
    echo
fi

# Start the server in production mode
echo "ğŸš€ Starting Agent Ironman..."
echo
export STANDALONE_BUILD=true
exec bun run server/server.ts "$@"
